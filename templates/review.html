<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPS Review</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- Optionally add more page-specific styles here -->
    </style>
</head>
<body>
    <div class="container-fluid">


        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-center flex-grow-1">Review GPS Data</h1>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-info" id="showHeatmapBtn" type="button">
                    <i class="bi bi-graph-up"></i> Show Heatmap
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary ms-3">
                    <i class="bi bi-arrow-left"></i> Back to Start
                </a>
            </div>
        </div>
    <!-- Heatmap Modal -->
    <div class="modal fade" id="heatmapModal" tabindex="-1" aria-labelledby="heatmapModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="heatmapModalLabel">GPS Heatmap of Loaded Images</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="heatmapMap" style="height: 600px; width: 100%; border-radius: 8px;"></div>
                </div>
            </div>
        </div>
    </div>
    

        <!-- Enhanced Flash Messages -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {% if category == 'success' %}
                                <i class="bi bi-check-circle-fill"></i>
                            {% elif category == 'danger' %}
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            {% elif category == 'warning' %}
                                <i class="bi bi-exclamation-octagon-fill"></i>
                            {% elif category == 'info' %}
                                <i class="bi bi-info-circle-fill"></i>
                            {% else %}
                                <i class="bi bi-info-circle-fill"></i>
                            {% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="counter text-center mb-4">
            Image {{ current_index }} of {{ total_entries }} | Changes made: <span id="changesMadeCount">{{ changes_made }}</span>
        </div>

        <div class="review-section">
            <!-- Left Pane: Image + Metadata -->
            <div class="left-pane">
                <div class="image-container">
                    <img src="{{ url_for('static', filename='uploads/' + image_url) }}" alt="Image to review">
                    
                    <!-- Metadata Box -->
                    <div class="metadata-box">
                        <h5>Original Metadata</h5>
                        <p><strong>Date Taken:</strong> {{ exif_info.get('DateTimeOriginal', 'Unknown') }}</p>
                        <p><strong>Latitude:</strong> {{ exif_info.get('GPSLatitude', 'Unknown') }}</p>
                        <p><strong>Longitude:</strong> {{ exif_info.get('GPSLongitude', 'Unknown') }}</p>
                        <p><strong>File Path:</strong> {{ file_location }}</p>
                    </div>
                </div>
            </div>

            <!-- Right Pane: Map + Form -->
            <div class="right-pane">
                <div id="map"></div>
                <div class="map-caption">
                    Click on the map or search for a location to set coordinates
                </div>

                <!-- Combined Form -->
                <div class="form-box">
                    <form method="POST" id="gpsForm">
                        <!-- Address Search -->
                        <div class="mb-3">
                            <label for="addressSearch" class="form-label">Search by Address</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="addressSearch" placeholder="Enter address or place name" autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" id="searchAddressBtn">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                            <div id="searchResults" class="autocomplete-results"></div>
                        </div>

                        <!-- Coordinate Inputs -->
                        <div class="mb-3">
                            <label for="latitude" class="form-label">Latitude
                              {% if entry.gps_source == 'proxy' %}
                                <span class="badge bg-warning text-dark ms-2" title="This is a suggested GPS value (proxy)">Suggested</span>
                              {% endif %}
                            </label>
                            <input type="text" class="form-control {% if entry.gps_source == 'proxy' %}bg-warning-subtle border-warning fw-bold{% endif %}" id="latitude" name="latitude" value="{{ entry.latitude }}" {% if entry.gps_source == 'proxy' %}data-bs-toggle="tooltip" data-bs-title="This is a suggested GPS value (proxy)"{% endif %} >
                        </div>
                        <div class="mb-3">
                            <label for="longitude" class="form-label">Longitude
                              {% if entry.gps_source == 'proxy' %}
                                <span class="badge bg-warning text-dark ms-2" title="This is a suggested GPS value (proxy)">Suggested</span>
                              {% endif %}
                            </label>
                            <input type="text" class="form-control {% if entry.gps_source == 'proxy' %}bg-warning-subtle border-warning fw-bold{% endif %}" id="longitude" name="longitude" value="{{ entry.longitude }}" {% if entry.gps_source == 'proxy' %}data-bs-toggle="tooltip" data-bs-title="This is a suggested GPS value (proxy)"{% endif %} >
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex flex-wrap">
                            <button type="submit" name="action" value="update" class="btn btn-success mb-2">
                                <i class="bi bi-geo-alt-fill"></i> Update GPS
                            </button>
                            <button type="submit" name="action" value="prev" class="btn btn-primary mb-2">
                                <i class="bi bi-arrow-left"></i> Previous
                            </button>                            <button type="submit" name="action" value="next" class="btn btn-primary mb-2">
                                <i class="bi bi-arrow-right"></i> Next
                            </button>
                            <button type="button" class="btn btn-warning mb-2" id="saveAllBtn" style="display: none;">
                                <i class="bi bi-save-fill"></i> Save All Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Progress Modal -->
    <div class="modal fade" id="saveProgressModal" tabindex="-1" aria-labelledby="saveProgressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveProgressModalLabel">Saving Changes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div id="saveProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="saveStatusText" class="text-center mt-2">Preparing to save...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>        // Pass entry latitude/longitude and GPS points to JS for review.js
        window.REVIEW_ENTRY_LAT = parseFloat("{{ entry.latitude }}") || 0;
        window.REVIEW_ENTRY_LNG = parseFloat("{{ entry.longitude }}") || 0;
        window.GPS_POINTS = {{ gps_points|tojson|safe }};
        
        // Set data attributes for controlling Save All button visibility
        window.IS_CSV_UPLOAD = {{ 'true' if source_type == 'csv' else 'false' }};
        window.IS_PROXY_GPS_SCAN = {{ 'true' if source_type == 'directory' and use_proxy == True else 'false' }};
        window.HAS_PROXY_GPS = {{ 'true' if has_proxy_gps else 'false' }};
    </script>
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>
</html>